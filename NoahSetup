#!/bin/bash
set -e

echo "=== Schritt 0: Infos sammeln ==="
echo "Ubuntu Version:"
lsb_release -a || true
echo "Kernel:"
uname -r
echo "Audio Hardware (lspci / aplay / arecord):"
lspci -nnk | grep -iA3 audio || true
cat /proc/asound/cards || true
aplay -l || true
arecord -l || true

echo
echo "=== Schritt 1: System update & wichtige Pakete installieren ==="
sudo apt update
sudo apt upgrade -y

# Allgemeine Audio-Pakete (ALSA + PulseAudio + Tools) + Firmware + GUI mixer
sudo apt install -y --no-install-recommends \
  alsa-base alsa-utils alsa-tools alsa-topology-conf \
  pulseaudio pavucontrol \
  linux-firmware \
  linux-generic \
  firmware-misc-nonfree || true

# Optional: falls du PipeWire statt PulseAudio willst (auskommentiere die 3 Zeilen, wenn NICHT gewünscht)
# sudo apt install -y pipewire pipewire-audio-client-libraries pipewire-pulse wireplumber
# systemctl --user enable --now pipewire pipewire-pulse wireplumber

echo
echo "=== Schritt 2: ALSA neu laden und PulseAudio neu starten ==="
# Versuche alsa neu zu laden (Befehl kann auf manchen Systemen fehlschlagen, daher || true)
sudo alsa force-reload || sudo /sbin/alsa-force-reload || true

# PulseAudio für den aktuellen Benutzer neu starten (benutzerseitig)
pulseaudio --kill 2>/dev/null || true
pulseaudio --start || true

echo
echo "=== Schritt 3: Kernel-Module nachladen (Realtek/HDA) ==="
sudo modprobe -r snd_hda_intel || true
sudo modprobe snd_hda_intel

echo
echo "=== Schritt 4: Bereinigen / Rechte / Reboot Empfehlungen ==="
# Setze alsa-state zurück (sicher)
sudo alsactl init || true

echo
echo "FERTIG. Bitte jetzt einmal neu starten, damit Kernel, firmware und Pulseaudio/PipeWire sauber starten:"
echo "   sudo reboot"
echo
echo "=== Hilfsbefehle / Tests nach Reboot ==="
echo "1) Ausgabegerät anzeigen:    pactl list short sinks"
echo "2) Eingang (Mikro) anzeigen: pactl list short sources"
echo "3) ALSA Test (Lautsprecher): speaker-test -c2 -t wav -l1"
echo "4) Mikro testen: arecord -f cd -d 5 /tmp/testmic.wav && aplay /tmp/testmic.wav"
echo "5) Log für audio-Fehler: sudo dmesg | grep -i snd; journalctl --since '5 minutes ago' --user -u pulseaudio.service"
echo
echo "Wenn nach Reboot noch kein Ton oder kein Mikro: die next steps sind: 1) Hardware-Codec anzeigen (cat /proc/asound/cards + grep), 2) Kernelversion prüfen, 3) ggf. ubuntu-audio-dev PPA oder spezielles oem/dkms Paket (vorsichtig) installieren."
